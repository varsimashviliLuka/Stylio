{% extends 'base.html' %}

{% block title %}
{{ salon.name }} â€¢ Book a Visit
{% endblock %}

{% block style %}
<style>
  .booking-wrap { max-width: 900px; margin: 0 auto; }
  .rounded-16 { border-radius: 16px; }

  .reveal { opacity: 0; transform: translateY(8px); transition: opacity .25s ease, transform .25s ease; }
  .reveal.show { opacity: 1; transform: translateY(0); }

  .selected { border: 2px solid #0d6efd !important; background: #f5f9ff; }

  .service-option { cursor: pointer; border-radius: 12px; transition: 0.2s; margin-bottom: 8px; }
  .service-option:hover { background: #f5f9ff; }

  .staff-card {
    border: 1px solid #dee2e6; border-radius: 14px; padding: 12px; text-align: center;
    cursor: pointer; transition: 0.3s; user-select: none;
  }
  .staff-card:hover { background: #f5f9ff; }

  .time-slot {
    border: 1px solid #dee2e6; border-radius: 12px; padding: 8px 16px;
    cursor: pointer; transition: 0.3s; font-weight: 500; user-select: none;
    display: inline-flex; align-items: center; gap: 8px;
  }
  .time-slot:hover { background: #f5f9ff; }

  .time-slot.disabled {
    opacity: .55;
    cursor: not-allowed;
  }

  .locked { opacity: .55; pointer-events: none; }

  input, textarea, select { cursor: text !important; }
  button, a, label.service-option, .staff-card, .time-slot { cursor: pointer; }

  .hours-pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    border: 1px solid #e9ecef;
    border-radius: 999px;
    background: #fff;
    font-size: 0.9rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="booking-wrap">

    <a href="{{ url_for('main.home_page') }}" class="text-decoration-none text-muted d-inline-flex align-items-center mb-4">
      <i class="bi bi-arrow-left me-2"></i> Back to Salons
    </a>

    <!-- âœ… TOP SALON CARD -->
    <div class="card shadow-sm border-0 mb-4 overflow-hidden rounded-16 reveal show">
      {% set photos = salon.photos|default([], true) %}
      {% set fallback = "https://e-macc.com/wp-content/uploads/2023/03/image-not-available-41955.png" %}

      <div id="bookingCarousel{{ salon.id }}" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner">

          {% if photos|length > 0 %}
            {% for p in photos %}
            <div class="carousel-item {% if loop.index0 == 0 %}active{% endif %}">
              <img src="{{ url_for('static', filename='uploads/' ~ p.file_path) }}" class="d-block w-100" style="height: 260px; object-fit: cover;">
            </div>
            {% endfor %}
          {% else %}
            <div class="carousel-item active">
              <img src="{{ fallback }}" class="d-block w-100" style="height: 260px; object-fit: cover;">
            </div>
          {% endif %}

        </div>

        {% if photos|length > 1 %}
        <button class="carousel-control-prev" type="button" data-bs-target="#bookingCarousel{{ salon.id }}" data-bs-slide="prev">
          <span class="carousel-control-prev-icon"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#bookingCarousel{{ salon.id }}" data-bs-slide="next">
          <span class="carousel-control-next-icon"></span>
        </button>
        {% endif %}
      </div>

      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div>
            <h3 class="fw-bold mb-1">{{ salon.name }}</h3>

            {% if salon.map_link %}
              <a
                href="{{ salon.map_link }}"
                target="_blank"
                rel="noopener"
                class="text-muted text-decoration-none d-inline-flex align-items-center"
              >
                <i class="bi bi-geo-alt-fill me-1 text-primary"></i>
                {{ salon.location|default("View on map", true) }}
              </a>
            {% else %}
              <p class="text-muted mb-0">
                <i class="bi bi-geo-alt-fill me-1 text-primary"></i>{{ salon.location|default("", true) }}
              </p>
            {% endif %}
          </div>

          <div class="text-end">
            {% if salon.average_review|default(0, true) == 0 %}
              <span class="text-muted fst-italic">Not reviewed yet</span>
            {% else %}
              <span class="text-warning">
                {% for i in range((salon.average_review|default(0, true))|int) %}<i class="bi bi-star-fill"></i>{% endfor %}
                {% for i in range(5 - ((salon.average_review|default(0, true))|int)) %}<i class="bi bi-star"></i>{% endfor %}
              </span>
              <div class="small text-muted">{{ salon.review_count|default(0, true) }} reviews</div>
            {% endif %}
          </div>
        </div>

        {% set tags = salon.tags|default([], true) %}
        {% if tags|length > 0 %}
        <div class="mt-3">
          {% for tag in tags %}
            <span class="badge bg-primary me-1">{{ tag }}</span>
          {% endfor %}
        </div>
        {% endif %}

                {# âœ… Working hours preview #}
{% set hours_lines = salon_hours_lines.get(salon.id, []) if salon_hours_lines else [] %}
{% if hours_lines|length > 0 %}
  <div class="small text-muted mb-2">
    <div class="fw-semibold text-secondary mb-1">
      <i class="bi bi-clock me-1"></i>Working hours
    </div>

    {% for line in hours_lines %}
      <div class="d-flex align-items-start gap-2">
        <span class="text-secondary">â€¢</span>
        <span>{{ line }}</span>
      </div>
    {% endfor %}
  </div>
{% endif %}

{# âœ… Special days preview (upcoming) #}
{% set spec_lines = salon_special_lines.get(salon.id, []) if salon_special_lines else [] %}
{% if spec_lines|length > 0 %}
  <div class="small mb-2">
    <div class="fw-semibold text-secondary mb-1">
      <i class="bi bi-calendar-event me-1"></i>Special days
    </div>

    {% for line in spec_lines %}
      <div class="d-flex align-items-start gap-2">
        <span class="text-secondary">â€¢</span>
        <span>{{ line }}</span>
      </div>
    {% endfor %}
  </div>
{% endif %}


        <p class="mt-3 text-muted mb-0">{{ salon.description|default("", true) }}</p>
      </div>
    </div>

    <!-- STEP 1: SERVICE -->
    <div id="stepService" class="card p-4 shadow-sm border-0 mb-4 rounded-16 reveal show">
      <h5 class="fw-semibold mb-1">1) Select a Service</h5>
      <p class="text-muted mb-3">Choose the service you'd like to book</p>

      <div class="list-group">
        {% for service in salon.services %}
        <label class="list-group-item service-option" data-service-id="{{ service.id }}">
          <input type="radio" name="service" hidden value="{{ service.id }}">
          <div class="d-flex justify-content-between">
            <div>
              <strong>{{ service.name }}</strong>
              <div class="small text-muted">{{ service.duration }} min</div>
            </div>
            <span class="fw-semibold">${{ service.price }}</span>
          </div>
        </label>
        {% endfor %}
      </div>
    </div>

    <!-- âœ… STEP 2: DATE (moved to 2nd) -->
    <div id="stepDate" class="card p-4 shadow-sm border-0 mb-4 rounded-16 reveal show locked">
      <h5 class="fw-semibold mb-1">2) Select Date</h5>
      <p class="text-muted mb-3">Choose your preferred appointment date</p>
      <input id="dateInput" type="date" class="form-control">

      <div id="closedDayMsg" class="small text-danger mt-2 d-none">
        This salon is closed on the selected date. Please choose another day.
      </div>
    </div>

    <!-- âœ… STEP 3: STAFF -->
    <div id="stepStaff" class="card p-4 shadow-sm border-0 mb-4 rounded-16 reveal d-none">
      <h5 class="fw-semibold mb-1">3) Select Staff Member</h5>
      <p class="text-muted mb-3">Only staff who offer the service and are not off all-day on that date will appear</p>

      <p id="noStaffMsg" class="text-muted fst-italic d-none mb-3">No staff available for this service on this date.</p>

      <div class="row g-3">
        {% for staff in salon.staff %}
          {% set ids = staff_service_ids.get(staff.id, []) %}
          <div class="col-md-4 staff-wrapper" data-service-ids='{{ ids | tojson }}'>
            <label class="staff-card w-100">
              <input type="radio" name="staff" hidden value="{{ staff.id }}">

              {% set fallback = "https://e-macc.com/wp-content/uploads/2023/03/image-not-available-41955.png" %}
              {% if staff.photo_path %}
                {% set img_src = url_for('static', filename=staff.photo_path.lstrip('/')) %}
              {% elif staff.image %}
                {% set img_src = staff.image %}
              {% else %}
                {% set img_src = fallback %}
              {% endif %}

              <img
                src="{{ img_src }}?v={{ staff.id }}"
                class="rounded-circle mb-2"
                width="80"
                height="80"
                style="object-fit: cover;"
                alt="{{ staff.name }}"
              >

              <h6 class="mb-0">{{ staff.name }}</h6>
              <small class="text-muted">{{ staff.profession or "" }}</small>
            </label>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- âœ… STEP 4: TIME (show salon hours for that day; block only staff-unavailable times) -->
    <div id="stepTime" class="card p-4 shadow-sm border-0 mb-4 rounded-16 reveal show locked">
      <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
        <div>
          <h5 class="fw-semibold mb-1">4) Select Time</h5>
          <p class="text-muted mb-0">Choose your preferred time slot</p>
        </div>

        <div id="salonHoursPill" class="hours-pill d-none">
          <i class="bi bi-clock text-primary"></i>
          <span class="text-muted">Hours:</span>
          <span id="salonHoursText" class="fw-semibold"></span>
        </div>
      </div>

      <div id="timeSlots" class="d-flex flex-wrap gap-2 mt-3"></div>

      <p id="timeHelp" class="small text-muted mt-2 mb-0 d-none">
        Some times are unavailable for selected staff.
      </p>
    </div>

    <!-- STEP 5: USER INFO -->
    <div id="stepInfo" class="card p-4 shadow-sm border-0 rounded-16 reveal show locked">
      <h5 class="fw-semibold mb-1">5) Your Information</h5>
      <p class="text-muted mb-3">Please provide your contact details</p>

      <form id="bookingForm" method="POST" action="{{ url_for('main.book_a_visit', id=salon.id) }}" novalidate>
        <input type="hidden" name="salon_name" value="{{ salon.name }}">
        <input type="hidden" name="salon_id" value="{{ salon.id }}">
        <input type="hidden" name="service" id="hiddenService">
        <input type="hidden" name="staff" id="hiddenStaff">
        <input type="hidden" name="date" id="hiddenDate">
        <input type="hidden" name="time" id="hiddenTime">

        <div class="row g-3">
          <div class="col-12">
            <label class="form-label">Full Name</label>
            <input id="fullName" name="full_name" type="text" class="form-control" placeholder="John Doe" required>
            <div class="invalid-feedback">Please enter your full name.</div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Email</label>
            <input id="email" name="email" type="email" class="form-control" placeholder="john@example.com" required>
            <div class="invalid-feedback">Please enter a valid email address.</div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Phone Number</label>
            <input id="phone" name="phone" type="tel" class="form-control" placeholder="+995 5xx xx xx xx" required>
            <div class="invalid-feedback">Please enter a valid phone number.</div>
          </div>

          <div class="col-12 mt-2">
            <button id="confirmBtn" type="submit" class="btn btn-primary w-100 py-2 fw-semibold">
              Confirm Booking
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="bookingSuccessModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-16">
          <div class="modal-header border-0">
            <h5 class="modal-title fw-bold">Booking Confirmed ðŸŽ‰</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p class="mb-2">Your booking request has been sent successfully.</p>
            <div class="small text-muted" id="bookingSummary"></div>
          </div>
          <div class="modal-footer border-0">
            <a href="{{ url_for('main.home_page') }}" class="btn btn-outline-secondary">Back to Salons</a>
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Done</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block javascript_bottom %}
<!-- âœ… Pass server data safely as JSON -->
<script id="bookingData" type="application/json">
{{ {
  "weekly_hours": weekly_hours or {},
  "special_days": special_days or {},
  "staff_day_blocks": staff_day_blocks or {},
  "staff_service_ids": staff_service_ids or {}
} | tojson }}
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const stepDate  = document.getElementById('stepDate');
  const stepStaff = document.getElementById('stepStaff');
  const stepTime  = document.getElementById('stepTime');
  const stepInfo  = document.getElementById('stepInfo');

  const dateInput = document.getElementById('dateInput');
  const closedDayMsg = document.getElementById('closedDayMsg');
  const noStaffMsg = document.getElementById('noStaffMsg');

  const bookingForm = document.getElementById('bookingForm');
  const fullNameInp = document.getElementById('fullName');
  const emailInp = document.getElementById('email');
  const phoneInp = document.getElementById('phone');

  const hiddenService = document.getElementById('hiddenService');
  const hiddenStaff   = document.getElementById('hiddenStaff');
  const hiddenDate    = document.getElementById('hiddenDate');
  const hiddenTime    = document.getElementById('hiddenTime');

  const bookingSummary = document.getElementById('bookingSummary');

  const timeSlotsWrap = document.getElementById('timeSlots');
  const timeHelp = document.getElementById('timeHelp');

  const salonHoursPill = document.getElementById('salonHoursPill');
  const salonHoursText = document.getElementById('salonHoursText');

  // âœ… read JSON payload
  const BOOKING_DATA_EL = document.getElementById("bookingData");
  const BOOKING_DATA = BOOKING_DATA_EL ? JSON.parse(BOOKING_DATA_EL.textContent) : {};

  const WEEKLY_HOURS = BOOKING_DATA.weekly_hours || {};
  const SPECIAL_DAYS = BOOKING_DATA.special_days || {};
  const STAFF_DAY_BLOCKS = BOOKING_DATA.staff_day_blocks || {};
  const STAFF_SERVICE_IDS = BOOKING_DATA.staff_service_ids || {};

  // full time options (hourly) â€” supports 06:00â€“23:00 (you can adjust)
  const FULL_TIMES = [];
  for (let h = 6; h <= 23; h++) FULL_TIMES.push(String(h).padStart(2, '0') + ':00');

  let selectedService = null;

  function smoothScrollTo(el) {
    if (!el) return;
    const elementTop = el.getBoundingClientRect().top + window.pageYOffset;
    const offset = window.innerHeight / 2 - el.offsetHeight / 2;
    window.scrollTo({ top: elementTop - offset, behavior: 'smooth' });
  }

  function lock(el)   { if (el) el.classList.add('locked'); }
  function unlock(el) { if (el) el.classList.remove('locked'); }

  function show(el) { if (el) { el.classList.remove('d-none'); el.classList.add('show'); } }
  function hide(el) { if (el) { el.classList.add('d-none'); el.classList.remove('show'); } }

  function clearStaffSelection() {
    document.querySelectorAll('.staff-card').forEach(card => card.classList.remove('selected'));
    document.querySelectorAll('input[name="staff"]').forEach(inp => inp.checked = false);
    hiddenStaff.value = "";
  }

  function clearTimeSelection() {
    hiddenTime.value = "";
    if (timeSlotsWrap) timeSlotsWrap.innerHTML = "";
    if (timeHelp) timeHelp.classList.add('d-none');
  }

  function clearHoursPill() {
    if (salonHoursPill) salonHoursPill.classList.add('d-none');
    if (salonHoursText) salonHoursText.textContent = "";
  }

  function ymdToWeekday(ymd) {
    const d = new Date(ymd + "T00:00:00");
    const js = d.getDay(); // 0=Sun..6=Sat
    return (js + 6) % 7;   // 0=Mon..6=Sun
  }

  function getSalonHoursForDate(ymd) {
    // special overrides first (SPECIAL_DAYS should be { "YYYY-MM-DD": {is_closed, start, end} })
    if (SPECIAL_DAYS && SPECIAL_DAYS[ymd]) return SPECIAL_DAYS[ymd];

    const wd = ymdToWeekday(ymd);
    const row = (WEEKLY_HOURS && (WEEKLY_HOURS[wd] || WEEKLY_HOURS[String(wd)]))
      ? (WEEKLY_HOURS[wd] || WEEKLY_HOURS[String(wd)])
      : null;

    if (!row) return { is_closed: false, start: "09:00", end: "19:00" };

    return {
      is_closed: !!row.is_closed,
      start: row.start || "09:00",
      end: row.end || "19:00",
    };
  }

  function isTimeInRange(t, start, end) {
    // start inclusive, end exclusive (09:00â€“19:00 => last selectable slot 18:00)
    return (t >= start) && (t < end);
  }

  function staffAllDayUnavailable(staffId, ymd) {
    const sid = String(staffId);
    if (!STAFF_DAY_BLOCKS || !STAFF_DAY_BLOCKS[sid] || !STAFF_DAY_BLOCKS[sid][ymd]) return false;
    return !!STAFF_DAY_BLOCKS[sid][ymd].all_day;
  }

  function staffUnavailableTimes(staffId, ymd) {
    const sid = String(staffId);
    if (!STAFF_DAY_BLOCKS || !STAFF_DAY_BLOCKS[sid] || !STAFF_DAY_BLOCKS[sid][ymd]) return [];
    if (STAFF_DAY_BLOCKS[sid][ymd].all_day) return FULL_TIMES.slice();
    return (STAFF_DAY_BLOCKS[sid][ymd].times || []).map(String);
  }

  function filterStaffByServiceAndDate(serviceId, ymd) {
    let anyVisible = false;

    document.querySelectorAll('.staff-wrapper').forEach(wrapper => {
      const staffRadio = wrapper.querySelector('input[name="staff"]');
      if (!staffRadio) return;

      const staffId = parseInt(staffRadio.value, 10);

      const canDoService = (STAFF_SERVICE_IDS[String(staffId)] || []).includes(serviceId);
      const allDayBlocked = staffAllDayUnavailable(staffId, ymd);

      const showIt = canDoService && !allDayBlocked;
      wrapper.style.display = showIt ? 'block' : 'none';
      if (showIt) anyVisible = true;
    });

    if (noStaffMsg) noStaffMsg.classList.toggle('d-none', anyVisible);
    return anyVisible;
  }

  function renderTimeSlots(ymd, staffIdOrNull) {
    clearTimeSelection();
    clearHoursPill();

    const hours = getSalonHoursForDate(ymd);
    if (!hours || hours.is_closed) return;

    // âœ… show salon hours for that day
    if (salonHoursPill && salonHoursText) {
      salonHoursText.textContent = `${hours.start} â€“ ${hours.end}`;
      salonHoursPill.classList.remove('d-none');
    }

    const allowed = FULL_TIMES.filter(t => isTimeInRange(t, hours.start, hours.end));
    const blocked = staffIdOrNull ? new Set(staffUnavailableTimes(staffIdOrNull, ymd)) : new Set();

    allowed.forEach(t => {
      const label = document.createElement('label');
      label.className = 'time-slot';
      label.innerHTML = `
        <input type="radio" name="time" hidden value="${t}">
        <i class="bi bi-clock text-primary"></i>
        <span>${t}</span>
      `;

      const input = label.querySelector('input');
      const isBlocked = staffIdOrNull ? blocked.has(t) : false;

      if (isBlocked) {
        label.classList.add('disabled');
        input.disabled = true;
      }

      label.addEventListener('click', (e) => {
        e.preventDefault();
        if (stepTime && stepTime.classList.contains('locked')) return;
        if (input.disabled) return;

        const already = input.checked;

        document.querySelectorAll('#timeSlots .time-slot').forEach(s => s.classList.remove('selected'));
        document.querySelectorAll('#timeSlots input[name="time"]').forEach(i => i.checked = false);

        if (already) {
          hiddenTime.value = "";
          lock(stepInfo);
        } else {
          input.checked = true;
          label.classList.add('selected');
          hiddenTime.value = t;
          unlock(stepInfo);
          smoothScrollTo(stepInfo);
        }
      });

      if (timeSlotsWrap) timeSlotsWrap.appendChild(label);
    });

    if (staffIdOrNull) {
      const hasBlocked = allowed.some(t => blocked.has(t));
      if (timeHelp) timeHelp.classList.toggle('d-none', !hasBlocked);
    } else {
      if (timeHelp) timeHelp.classList.add('d-none');
    }
  }

  function resetAfterService() {
    clearStaffSelection();
    if (dateInput) dateInput.value = '';
    hiddenDate.value = "";
    clearTimeSelection();
    clearHoursPill();

    hiddenService.value = "";
    selectedService = null;

    lock(stepDate);
    lock(stepStaff);
    lock(stepTime);
    lock(stepInfo);

    hide(stepStaff);
    if (noStaffMsg) noStaffMsg.classList.add('d-none');
    document.querySelectorAll('.staff-wrapper').forEach(w => (w.style.display = 'none'));
    if (closedDayMsg) closedDayMsg.classList.add('d-none');
  }

  // âœ… Step 1: service -> unlock date (2nd step)
  document.querySelectorAll('.service-option').forEach(option => {
    option.addEventListener('click', (e) => {
      e.preventDefault();

      const input = option.querySelector('input[name="service"]');
      const serviceId = parseInt(input.value, 10);

      // toggle off
      if (selectedService === serviceId) {
        document.querySelectorAll('.service-option').forEach(o => o.classList.remove('selected'));
        document.querySelectorAll('input[name="service"]').forEach(i => (i.checked = false));
        resetAfterService();
        return;
      }

      selectedService = serviceId;

      document.querySelectorAll('.service-option').forEach(o => o.classList.remove('selected'));
      option.classList.add('selected');
      document.querySelectorAll('input[name="service"]').forEach(i => (i.checked = false));
      input.checked = true;

      hiddenService.value = String(serviceId);

      // reset downstream
      clearStaffSelection();
      if (dateInput) dateInput.value = '';
      hiddenDate.value = "";
      clearTimeSelection();
      clearHoursPill();
      if (closedDayMsg) closedDayMsg.classList.add('d-none');

      unlock(stepDate);
      lock(stepStaff);
      lock(stepTime);
      lock(stepInfo);

      hide(stepStaff);
      if (noStaffMsg) noStaffMsg.classList.add('d-none');
      document.querySelectorAll('.staff-wrapper').forEach(w => (w.style.display = 'none'));

      smoothScrollTo(stepDate);
    });
  });

  // âœ… Step 2: date -> must be open -> show staff (step 3)
  if (dateInput) {
    dateInput.addEventListener('change', () => {
      if (!selectedService) return;

      const ymd = dateInput.value || "";
      hiddenDate.value = ymd;

      clearStaffSelection();
      clearTimeSelection();
      clearHoursPill();
      lock(stepTime);
      lock(stepInfo);

      if (!ymd) {
        lock(stepStaff);
        hide(stepStaff);
        if (closedDayMsg) closedDayMsg.classList.add('d-none');
        return;
      }

      const hours = getSalonHoursForDate(ymd);
      if (!hours || hours.is_closed) {
        lock(stepStaff);
        hide(stepStaff);
        if (closedDayMsg) closedDayMsg.classList.remove('d-none');
        return;
      }

      if (closedDayMsg) closedDayMsg.classList.add('d-none');

      // show + filter staff
      show(stepStaff);
      unlock(stepStaff);

      const anyStaff = filterStaffByServiceAndDate(selectedService, ymd);
      smoothScrollTo(stepStaff);

      if (!anyStaff) {
        lock(stepTime);
        lock(stepInfo);
      }
    });
  }

  // âœ… Step 3: staff -> unlock time (step 4)
  document.querySelectorAll('.staff-card').forEach(card => {
    card.addEventListener('click', (e) => {
      e.preventDefault();
      if (stepStaff && stepStaff.classList.contains('d-none')) return;
      if (stepStaff && stepStaff.classList.contains('locked')) return;

      const input = card.querySelector('input[name="staff"]');
      if (!input) return;

      const staffId = parseInt(input.value, 10);
      const ymd = hiddenDate.value;
      if (!ymd) return;

      // toggle selection
      if (input.checked) {
        input.checked = false;
        card.classList.remove('selected');
        hiddenStaff.value = "";

        lock(stepTime);
        clearTimeSelection();
        clearHoursPill();
        lock(stepInfo);
        return;
      }

      document.querySelectorAll('.staff-card').forEach(c => c.classList.remove('selected'));
      document.querySelectorAll('input[name="staff"]').forEach(i => (i.checked = false));

      input.checked = true;
      card.classList.add('selected');
      hiddenStaff.value = String(staffId);

      unlock(stepTime);
      renderTimeSlots(ymd, staffId);
      smoothScrollTo(stepTime);
    });
  });

  // âœ… submit validation
  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(String(email).toLowerCase());
  }
  function isValidPhone(phone) {
    return /^[+]?[\d\s\-()]{7,20}$/.test(String(phone));
  }
  function setValidity(inputEl, ok) {
    inputEl.classList.toggle('is-invalid', !ok);
    inputEl.classList.toggle('is-valid', ok);
  }

  bookingForm.addEventListener('submit', async function (e) {
    e.preventDefault();

    const hasService = !!hiddenService.value;
    const hasDate = !!hiddenDate.value;
    const hasStaff = !!hiddenStaff.value;
    const hasTime = !!hiddenTime.value;

    const nameOk = fullNameInp.value.trim().length >= 2;
    const emailOk = isValidEmail(emailInp.value.trim());
    const phoneOk = isValidPhone(phoneInp.value.trim());

    setValidity(fullNameInp, nameOk);
    setValidity(emailInp, emailOk);
    setValidity(phoneInp, phoneOk);

    if (!hasService || !hasDate || !hasStaff || !hasTime) {
      alert("Please select service, date, staff, and time first.");
      return;
    }
    if (!nameOk || !emailOk || !phoneOk) return;

    const confirmBtn = document.getElementById('confirmBtn');
    const oldBtnText = confirmBtn.innerHTML;
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Booking...`;

    try {
      const formData = new FormData(bookingForm);

      const res = await fetch(bookingForm.action, {
        method: 'POST',
        body: formData,
        headers: { "X-Requested-With": "fetch" }
      });

      if (!res.ok) throw new Error("Server error");

      const json = await res.json();
      if (!json.ok) throw new Error(json.message || "Booking failed");

      const selectedOption = document.querySelector('.service-option.selected');
      const serviceText = selectedOption ? selectedOption.querySelector('strong')?.textContent : hiddenService.value;

      const staffCard = document.querySelector('.staff-card.selected h6');
      const staffText = staffCard ? staffCard.textContent : hiddenStaff.value;

      bookingSummary.innerHTML = `
        <div><strong>Service:</strong> ${serviceText}</div>
        <div><strong>Staff:</strong> ${staffText}</div>
        <div><strong>Date:</strong> ${hiddenDate.value}</div>
        <div><strong>Time:</strong> ${hiddenTime.value}</div>
        <hr class="my-2">
        <div><strong>Name:</strong> ${fullNameInp.value}</div>
        <div><strong>Email:</strong> ${emailInp.value}</div>
        <div><strong>Phone:</strong> ${phoneInp.value}</div>
      `;

      const modal = new bootstrap.Modal(document.getElementById('bookingSuccessModal'));
      modal.show();

    } catch (err) {
      alert("Booking failed. Please try again.");
      console.error(err);
    } finally {
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = oldBtnText;
    }
  });

  // init
  resetAfterService();
});
</script>
{% endblock %}
